# 系统架构流程图

## 1. 整体系统架构

```mermaid
graph TB
    subgraph "客户端层"
        API_CLIENT[API客户端]
    end
    
    subgraph "应用服务层"
        FASTAPI[FastAPI应用<br/>app.py]
        MAIN[主入口<br/>main.py]
        CONFIG[配置管理<br/>config.py]
    end
    
    subgraph "API路由层"
        EXP_API[实验API<br/>experiment_api]
        FLOW_API[流程API<br/>flow_api]
        MIXER_API[配料API<br/>mixer_api]
        ROBOT_API[机器人API<br/>plc_api]
        CENT_API[离心机API<br/>centrifuge_api]
        OVEN_API[高温炉API<br/>oven_api]
        DOOR_API[防护门API<br/>door_api]
        SYS_API[系统API<br/>system_api]
    end
    
    subgraph "业务服务层"
        MIXER_SVC[配料服务<br/>mixer_service]
        FLOW_MGR[流程管理器<br/>FlowManager]
    end
    
    subgraph "设备控制层"
        BASE[设备基类<br/>BaseDevice]
        ROBOT_CTRL[机器人控制器<br/>RobotController<br/>PLC通信]
        MIXER_CTRL[配料控制器<br/>MixerController<br/>REST API]
        CENT_CTRL[离心机控制器<br/>CentrifugeController<br/>Modbus]
        OVEN_CTRL[高温炉控制器<br/>OvenController<br/>Socket/ZMQ]
        DOOR_CTRL[防护门控制器<br/>DoorController<br/>Socket/ZMQ]
        XRD_CTRL[XRD控制器<br/>XRDController<br/>REST API]
    end
    
    subgraph "通信协议层"
        PLC_PROTO[PLC协议<br/>snap7]
        MODBUS_PROTO[Modbus协议<br/>TCP]
        SOCKET_PROTO[Socket协议<br/>ZMQ]
        REST_PROTO[REST API<br/>HTTP]
        SERIAL_PROTO[Serial协议<br/>Serial]
    end
    
    subgraph "硬件设备层"
        ROBOT[机器人/机械臂]
        MIXER[配料设备]
        CENTRIFUGE[离心机]
        OVEN[高温炉]
        DOOR[防护门]
        XRD[XRD衍射仪]
    end
    
    API_CLIENT --> FASTAPI
    MAIN --> FASTAPI
    CONFIG --> FASTAPI
    
    FASTAPI --> EXP_API
    FASTAPI --> FLOW_API
    FASTAPI --> MIXER_API
    FASTAPI --> ROBOT_API
    FASTAPI --> CENT_API
    FASTAPI --> OVEN_API
    FASTAPI --> DOOR_API
    FASTAPI --> SYS_API
    
    EXP_API --> MIXER_SVC
    EXP_API --> FLOW_MGR
    EXP_API --> MIXER_CTRL
    EXP_API --> XRD_CTRL
    
    FLOW_API --> FLOW_MGR
    MIXER_API --> MIXER_CTRL
    ROBOT_API --> ROBOT_CTRL
    CENT_API --> CENT_CTRL
    OVEN_API --> OVEN_CTRL
    DOOR_API --> DOOR_CTRL
    
    FLOW_MGR --> ROBOT_CTRL
    FLOW_MGR --> OVEN_CTRL
    FLOW_MGR --> DOOR_CTRL
    FLOW_MGR --> CENT_CTRL
    
    BASE --> ROBOT_CTRL
    BASE --> MIXER_CTRL
    BASE --> CENT_CTRL
    BASE --> OVEN_CTRL
    BASE --> DOOR_CTRL
    BASE --> XRD_CTRL
    
    ROBOT_CTRL --> PLC_PROTO
    CENT_CTRL --> MODBUS_PROTO
    OVEN_CTRL --> SOCKET_PROTO
    DOOR_CTRL --> SOCKET_PROTO
    MIXER_CTRL --> REST_PROTO
    XRD_CTRL --> REST_PROTO
    
    PLC_PROTO --> ROBOT
    MODBUS_PROTO --> CENTRIFUGE
    SOCKET_PROTO --> OVEN
    SOCKET_PROTO --> DOOR
    REST_PROTO --> MIXER
    REST_PROTO --> XRD
```

## 2. 设备控制类继承关系

```mermaid
classDiagram
    class BaseDevice {
        <<abstract>>
        +device_name: str
        +control_type: str
        +is_connected: bool
        +status: DeviceStatus
        +connect()
        +disconnect()
        +start()
        +stop()
        +get_status()
        +get_result()
        +get_message()
    }
    
    class PLCControlledDevice {
        +plc_ip: str
        +plc_port: int
        +client: snap7.Client
        +try_connect()
        +read_m()
        +write_task()
    }
    
    class ModbusControlledDevice {
        +modbus_addr: int
        +modbus_port: int
        +modbus_client
    }
    
    class SocketControlledDevice {
        +socket_address: str
        +context: zmq.Context
        +socket: zmq.Socket
    }
    
    class RestAPIControlledDevice {
        +api_base_url: str
        +api_token: str
        +api_headers: dict
    }
    
    class RobotController {
        +write_task()
        +dispatch_task()
        +get_system_status()
    }
    
    class CentrifugeController {
        +send_raw()
        +open_door()
        +close_door()
        +build_write_command()
    }
    
    class OvenController {
        +get_device_list()
        +get_realtime_data()
        +control_lid()
    }
    
    class DoorController {
        +get_door_status()
        +send_command()
    }
    
    class MixerController {
        +get_task_info()
        +add_task()
        +start_task()
        +stop_task()
        +cancel_task()
    }
    
    class XRDController {
        +start()
        +stop()
    }
    
    BaseDevice <|-- PLCControlledDevice
    BaseDevice <|-- ModbusControlledDevice
    BaseDevice <|-- SocketControlledDevice
    BaseDevice <|-- RestAPIControlledDevice
    
    PLCControlledDevice <|-- RobotController
    ModbusControlledDevice <|-- CentrifugeController
    SocketControlledDevice <|-- OvenController
    SocketControlledDevice <|-- DoorController
    RestAPIControlledDevice <|-- MixerController
    RestAPIControlledDevice <|-- XRDController
```

## 3. 实验流程状态机

```mermaid
stateDiagram-v2
    [*] --> PENDING: 创建任务
    
    PENDING --> WAITING_MATERIAL: 开始实验
    WAITING_MATERIAL --> MIXING: 人工确认装料
    MIXING --> WAITING_SEAL: 配料完成
    WAITING_SEAL --> SEALING: 人工放入熔封设备
    SEALING --> WAITING_RACK: 熔封完成
    WAITING_RACK --> SAMPLING_IN: 人工放入货架
    SAMPLING_IN --> HEATING: 机器人送样完成
    HEATING --> SAMPLING_OUT: 高温炉加热完成
    SAMPLING_OUT --> CENTRIFUGING: 机器人取样完成
    CENTRIFUGING --> WAITING_FIX: 离心机处理完成
    WAITING_FIX --> XRD_MEASURING: 人工修整样品
    XRD_MEASURING --> COMPLETED: XRD测量完成
    
    MIXING --> FAILED: 配料失败
    SEALING --> FAILED: 熔封失败
    HEATING --> FAILED: 加热失败
    CENTRIFUGING --> FAILED: 离心失败
    XRD_MEASURING --> FAILED: 测量失败
    
    FAILED --> [*]
    COMPLETED --> [*]
    
    note right of WAITING_MATERIAL
        等待人工装料确认
    end note
    
    note right of WAITING_SEAL
        等待人工放入熔封设备
    end note
    
    note right of WAITING_RACK
        等待人工放入货架
    end note
    
    note right of WAITING_FIX
        等待人工修整样品
    end note
```

## 4. 上料流程（Load Flow）

```mermaid
sequenceDiagram
    participant Client as 客户端
    participant API as Flow API
    participant FM as FlowManager
    participant Robot as 机器人控制器
    participant Oven as 高温炉控制器
    participant Door as 防护门控制器
    
    Client->>API: POST /api/flow/load
    API->>FM: load(shelf_id, oven_id, qty)
    
    Note over FM: 创建任务队列
    
    FM->>Robot: write_task(tid=1, st=shelf_id)
    FM->>Robot: 下发任务 dispatch_task()
    Robot-->>FM: 任务已启动
    
    Note over Robot: 机器人从货架取料
    
    loop 等待机器人完成
        FM->>Robot: get_system_status()
        Robot-->>FM: 状态更新
    end
    
    FM->>Robot: write_task(tid=5, st=oven_id)
    FM->>Robot: 下发任务 dispatch_task()
    
    FM->>Oven: 开炉盖 control_lid(oven_id, open)
    FM->>Door: 开自动门 send_command(door_id, open)
    
    Note over FM: 等待人工确认
    FM->>FM: confirm_event.wait()
    
    Client->>API: POST /api/flow/confirm_continue
    API->>FM: user_confirm()
    FM->>FM: confirm_event.set()
    
    Note over Robot: 机器人放入炉子
    
    loop 等待机器人回原点
        FM->>Robot: get_system_status()
        Robot-->>FM: 状态更新
    end
    
    FM->>Oven: 关炉盖 control_lid(oven_id, close)
    FM->>Door: 关自动门 send_command(door_id, close)
    
    FM-->>API: 流程完成
    API-->>Client: 返回结果
```

## 5. 出料流程（Unload Flow）

```mermaid
sequenceDiagram
    participant Client as 客户端
    participant API as Flow API
    participant FM as FlowManager
    participant Robot as 机器人控制器
    participant Oven as 高温炉控制器
    participant Door as 防护门控制器
    participant Cent as 离心机控制器
    
    Client->>API: POST /api/flow/unload
    API->>FM: unload(oven_id, slot_id, shelf_id)
    
    Note over FM: 创建任务队列
    
    rect rgb(71, 43, 43)
        Note over FM,Robot: 步骤1: 炉子取
        FM->>Oven: 开炉盖 control_lid(oven_id, open)
        FM->>Door: 开自动门 send_command(door_id, open)
        FM->>FM: 等待人工确认1
        Client->>API: POST /api/flow/confirm_continue
        API->>FM: user_confirm()
        FM->>Robot: write_task(tid=6, st=oven_id)
        FM->>Robot: 下发任务 dispatch_task()
    end
    
    rect rgb(126, 129, 126)
        Note over FM,Robot: 步骤2: 离心机放
        FM->>Cent: 开离心机门 open_door()
        FM->>FM: 等待人工确认2
        Client->>API: POST /api/flow/confirm_continue
        API->>FM: user_confirm()
        FM->>Robot: write_task(tid=3, st=3)
        FM->>Robot: dispatch_task()
    end
    
    rect rgb(42, 42, 45)
        Note over FM,Robot: 步骤3: 离心机取
        FM->>Cent: 开离心机门 open_door()
        FM->>FM: 等待人工确认3
        Client->>API: POST /api/flow/confirm_continue
        API->>FM: user_confirm()
        FM->>Robot: write_task(tid=4, st=4)
        FM->>Robot: dispatch_task()
    end
    
    rect rgb(63, 63, 58)
        Note over FM,Robot: 步骤4: 货架放
        FM->>Robot: write_task(tid=2, st=shelf_id)
        FM->>Robot: dispatch_task()
        Note over Robot: 无需确认，直接执行
    end
    
    FM-->>API: 流程完成
    API-->>Client: 返回结果
```

## 6. 完整实验流程（Experiment Flow）

```mermaid
flowchart TD
    START([开始实验]) --> UPLOAD[上传Excel文件]
    UPLOAD --> PARSE[解析配料数据]
    
    PARSE --> MIXER_CREATE[创建配料任务]
    MIXER_CREATE --> MIXER_START[启动配料任务]
    MIXER_START --> MIXER_WAIT{配料完成?}
    MIXER_WAIT -->|否| MIXER_WAIT
    MIXER_WAIT -->|是| SEAL[熔封处理]
    
    SEAL --> SEAL_WAIT{熔封完成?}
    SEAL_WAIT -->|否| SEAL_WAIT
    SEAL_WAIT -->|是| LOAD[启动上料流程]
    
    LOAD --> LOAD_ROBOT[机器人取料]
    LOAD_ROBOT --> LOAD_OVEN[打开炉盖和门]
    LOAD_OVEN --> LOAD_CONFIRM{人工确认}
    LOAD_CONFIRM -->|未确认| LOAD_CONFIRM
    LOAD_CONFIRM -->|已确认| LOAD_PLACE[机器人放入炉子]
    LOAD_PLACE --> LOAD_CLOSE[关闭炉盖和门]
    LOAD_CLOSE --> HEAT[高温炉加热]
    
    HEAT --> HEAT_WAIT{加热完成?}
    HEAT_WAIT -->|否| HEAT_WAIT
    HEAT_WAIT -->|是| UNLOAD[启动出料流程]
    
    UNLOAD --> UNLOAD_TAKE[从炉子取料]
    UNLOAD_TAKE --> UNLOAD_CENT1[放入离心机]
    UNLOAD_CENT1 --> CENT[离心机处理]
    CENT --> CENT_WAIT{离心完成?}
    CENT_WAIT -->|否| CENT_WAIT
    CENT_WAIT -->|是| UNLOAD_CENT2[从离心机取料]
    UNLOAD_CENT2 --> UNLOAD_SHELF[放入货架]
    
    UNLOAD_SHELF --> XRD_START[启动XRD测量]
    XRD_START --> XRD_WAIT{XRD完成?}
    XRD_WAIT -->|否| XRD_WAIT
    XRD_WAIT -->|是| END([实验完成])
    
    style START fill:#90EE90
    style END fill:#90EE90
    style LOAD_CONFIRM fill:#FFD700
    style MIXER_WAIT fill:#FFE4B5
    style HEAT_WAIT fill:#FFE4B5
    style CENT_WAIT fill:#FFE4B5
    style XRD_WAIT fill:#FFE4B5
```

## 7. 数据流向图

```mermaid
flowchart LR
    subgraph "输入"
        EXCEL[Excel文件]
        API_REQ[API请求]
    end
    
    subgraph "处理层"
        PARSER[数据解析器]
        FLOW_ENGINE[流程引擎]
        TASK_QUEUE[任务队列]
    end
    
    subgraph "设备控制"
        DEVICES[设备控制器]
    end
    
    subgraph "输出"
        LOGS[日志系统]
        STATUS[状态反馈]
        RESULT[实验结果]
    end
    
    EXCEL --> PARSER
    API_REQ --> FLOW_ENGINE
    PARSER --> FLOW_ENGINE
    FLOW_ENGINE --> TASK_QUEUE
    TASK_QUEUE --> DEVICES
    DEVICES --> STATUS
    DEVICES --> LOGS
    STATUS --> RESULT
    LOGS --> RESULT
```

## 8. 配置管理架构

```mermaid
graph TB
    ENV[.env文件] --> CONFIG[config.py]
    CONFIG --> APP[app.py]
    CONFIG --> DEVICES[设备控制器]
    
    CONFIG --> PLC_CFG[PLC配置]
    CONFIG --> CENT_CFG[离心机配置]
    CONFIG --> OVEN_CFG[高温炉配置]
    CONFIG --> DOOR_CFG[防护门配置]
    CONFIG --> MIXER_CFG[配料设备配置]
    CONFIG --> APP_CFG[应用配置]
    
    PLC_CFG --> ROBOT_CTRL[机器人控制器]
    CENT_CFG --> CENT_CTRL[离心机控制器]
    OVEN_CFG --> OVEN_CTRL[高温炉控制器]
    DOOR_CFG --> DOOR_CTRL[防护门控制器]
    MIXER_CFG --> MIXER_CTRL[配料控制器]
    APP_CFG --> MAIN[main.py]
```

## 9. 通信协议映射

```mermaid
graph LR
    subgraph "设备控制器"
        R[RobotController]
        C[CentrifugeController]
        O[OvenController]
        D[DoorController]
        M[MixerController]
        X[XRDController]
    end
    
    subgraph "通信协议"
        PLC[PLC/snap7<br/>TCP:502]
        MODBUS[Modbus TCP<br/>TCP:8000]
        ZMQ[ZMQ Socket<br/>TCP:49200-49206]
        REST[REST API<br/>HTTP:4669]
    end
    
    subgraph "硬件设备"
        ROBOT_HW[机器人/机械臂]
        CENT_HW[离心机]
        OVEN_HW[高温炉]
        DOOR_HW[防护门]
        MIXER_HW[配料设备]
        XRD_HW[XRD衍射仪]
    end
    
    R -->|PLC协议| PLC
    C -->|Modbus协议| MODBUS
    O -->|ZMQ协议| ZMQ
    D -->|ZMQ协议| ZMQ
    M -->|REST API| REST
    X -->|REST API| REST
    
    PLC --> ROBOT_HW
    MODBUS --> CENT_HW
    ZMQ --> OVEN_HW
    ZMQ --> DOOR_HW
    REST --> MIXER_HW
    REST --> XRD_HW
```

## 说明

### 系统层次结构

1. **客户端层**：API客户端
2. **应用服务层**：FastAPI应用、主入口、配置管理
3. **API路由层**：8个API路由模块，提供RESTful接口
4. **业务服务层**：配料服务、流程管理器
5. **设备控制层**：6个设备控制器，统一继承BaseDevice
6. **通信协议层**：4种通信协议（PLC、Modbus、Socket、REST）
7. **硬件设备层**：6种物理设备

### 关键特性

- **统一设备接口**：所有设备继承BaseDevice，提供统一的操作接口
- **流程编排**：FlowManager协调多个设备完成复杂流程
- **人工确认机制**：关键步骤需要人工确认，确保安全
- **状态管理**：完整的设备状态和任务状态管理
- **配置管理**：通过.env文件统一管理配置
- **日志系统**：完整的日志记录和查询功能
